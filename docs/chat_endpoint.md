# Эндпоинт /chat

## Описание

Эндпоинт `/chat` обрабатывает сообщения от веб-фронтенда и возвращает ответы от AI-агента.

## Реализация

Основная реализация находится в `main.py` (строка 198).

### Входные данные

- `message` (str) - текст сообщения пользователя
- `thread_id` (str) - UUID сессии с фронтенда
- `language` (str, опционально) - язык интерфейса (по умолчанию "ru")

### Процесс работы

1. **Создание виртуального пользователя**: Из `thread_id` создается виртуальный `User` объект для совместимости с админ-панелью
2. **Отправка в админ-панель**: Сообщение пользователя пересылается в Telegram админ-группу (если настроено)
3. **Обработка агентом**: 
   - Создается `HumanMessage` из текста
   - Формируется конфигурация LangGraph с `thread_id` и `language`
   - Вызывается `router_agent.invoke()` асинхронно
4. **Проверка CallManager**: Проверяется, был ли вызван CallManager (менеджер по звонкам)
5. **Извлечение ответа**: Из результата агента извлекается последнее `AIMessage`
6. **Отправка в админ-панель**: Ответ AI отправляется в админ-панель
7. **Возврат ответа**: Возвращается `WebChatResponse` с текстом ответа

## Отличия от Telegram

| Аспект | `/chat` (веб) | Telegram |
|--------|---------------|----------|
| **Пользователь** | Виртуальный User из `thread_id` | Реальный User из Telegram |
| **Thread ID** | UUID с фронтенда | `user_id` из Telegram |
| **Язык** | Передается в запросе (по умолчанию "ru") | Всегда "ru" |
| **Обработка** | Синхронный HTTP ответ | Асинхронная обработка через webhook |
| **Админ-панель** | Поддерживается | Поддерживается |
| **CallManager** | Проверяется и уведомляет админов | Проверяется и уведомляет админов |
| **История** | Сохраняется по `thread_id` | Сохраняется по `user_id` |

## Упрощенная версия

В `app/fast_api_app.py` есть упрощенная версия `/chat` (строка 213):
- Не создает виртуального пользователя
- Не отправляет в админ-панель
- Не проверяет CallManager
- Просто возвращает ответ агента

## Используемые компоненты

- `get_router_agent()` - получение роутер-агента
- `AdminPanelService` - сервис админ-панели
- `check_call_manager_in_messages()` - проверка вызова CallManager
- LangGraph checkpoint - сохранение истории диалога

